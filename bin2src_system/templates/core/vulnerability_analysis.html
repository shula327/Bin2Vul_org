{% extends 'core/base.html' %}
{% load core_filters %}

{% block title %}漏洞函数相似性分析 - Bin2Vul{% endblock %}

{% block content %}
<div class="vulnerability-theme">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">首页</a></li>
                    <li class="breadcrumb-item active">漏洞函数相似性分析</li>
                </ol>
            </nav>
            <h1 class="h3 mb-2">漏洞函数相似性分析</h1>
            <p class="text-muted">上传二进制文件，系统将与漏洞函数源码库进行比对分析</p>
        </div>
    </div>
</div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="{{ form.file.id_for_label }}" class="form-label">
                                <i class="fas fa-file-code me-2"></i>二进制文件
                            </label>
                            {{ form.file }}
                            {% if form.file.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.file.errors|join:", " }}
                                </div>
                            {% endif %}
                            <div class="form-text">支持的文件格式：ELF, EXE</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-shield-alt me-2"></i>开始分析
                            </button>
                        </div>
                        
                        <!-- 分析进度条，默认隐藏 -->
                        <div id="analysisProgress" class="mt-4 d-none">
                            <p class="text-center mb-2">正在进行漏洞函数分析，请稍候...</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100" 
                                     style="width: 0%">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            <p class="text-center small text-muted mt-2" id="analysisStage">准备分析二进制文件...</p>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if overall_result %}
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-pie me-2"></i>分析结果概览
                    </h5>
                    <div class="alert alert-{% if overall_result.similarity_percentage > 70 %}danger{% elif overall_result.similarity_percentage > 50 %}warning{% else %}info{% endif %} mb-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-{% if overall_result.similarity_percentage > 70 %}exclamation-triangle{% elif overall_result.similarity_percentage > 50 %}exclamation-circle{% else %}info-circle{% endif %} fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="alert-heading">检测到可能的漏洞函数如下</h5>
                            </div>
                        </div>
                    </div>
                    
                    <p>共分析了 <strong>{{ total_files }}</strong> 个漏洞源码文件和 <strong>{{ total_functions }}</strong> 个二进制函数</p>
                    
                    <div class="text-muted mt-3 mb-4">
                        <p class="small">* 相似度分数基于二进制代码函数与已知漏洞函数源码的匹配程度。分数越高，潜在风险越大。</p>
                    </div>
                </div>
            </div>
            
            <!-- 函数级别漏洞分析结果 -->
            <div class="card mt-4">
                <div class="card-header bg-danger text-white">
                    <i class="fas fa-code me-2"></i>函数级别漏洞分析
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">函数名</th>
                                    <th scope="col">漏洞类型</th>
                                    <th scope="col">相似度</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in function_results %}
                                <tr class="{% if forloop.first %}table-danger{% endif %}">
                                    <th scope="row">{{ forloop.counter }}</th>
                                    <td>
                                        {{ result.func_name }}
                                        <div class="small text-muted">偏移量: {{ result.func_offset }}</div>
                                    </td>
                                    <td>{{ result.vulnerability_type }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1" style="height: 8px;">
                                                <div class="progress-bar bg-{% if result.similarity_percentage > 70 %}danger{% elif result.similarity_percentage > 50 %}warning{% else %}info{% endif %}"
                                                     role="progressbar"
                                                     style="width: {{ result.similarity_percentage }}%"
                                                     aria-valuenow="{{ result.similarity_percentage }}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span class="ms-2">{{ result.similarity_percentage|floatformat:2 }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <div class="vulnerability-theme">
                        <i class="fas fa-info-circle me-2"></i>使用说明
                        </div>
                    </h5>
                    <div class="vulnerability-theme">
                    <div class="card-text">
                        <p>本功能用于分析二进制文件的函数中的潜在漏洞，可以帮助您：</p>
                        <ul class="mb-0">
                            <li>检测已知漏洞模式</li>
                            <li>识别安全风险</li>
                            <li>评估代码安全性</li>
                            <li>预防潜在威胁</li>
                        </ul>
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- 添加新的函数级别漏洞分析说明 -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-search me-2"></i>CWE漏洞查询
                </div>
                <div class="card-body">
                    <form id="cwe-search-form">
                        <div class="input-group mb-3">
                            <input type="number" class="form-control" id="cwe-number" placeholder="输入CWE编号" min="1" max="9999">
                            <button class="btn btn-primary" type="submit" id="search-cwe-btn">
                                <i class="fas fa-search"></i> 查询
                            </button>
                        </div>
                    </form>
                    <div id="cwe-result" class="mt-3">
                        <div class="text-center text-muted small">
                            <p>输入CWE编号查询漏洞详情</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 漏洞类型分布饼状图和表格 -->
            {% if overall_result %}
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>漏洞类型分布
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <canvas id="vulnTypePieChart" width="100" height="100"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>漏洞类型</th>
                                    <th>函数数量</th>
                                    <th>比例</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vuln_type, data in vuln_type_percentages.items %}
                                <tr>
                                    <td>{{ vuln_type }}</td>
                                    <td>{{ data.count }}</td>
                                    <td>{{ data.percentage|floatformat:1 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>   
    </div>

{% endblock %}

{% block extra_js %}
<!-- 引入Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    const analysisProgress = document.getElementById('analysisProgress');
    const progressBar = analysisProgress.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    const analysisStage = document.getElementById('analysisStage');
    
    // 分析阶段描述
    const analysisStages = [
        "准备分析二进制文件...",
        "提取函数特征...",
        "比对已知漏洞库...",
        "分析代码相似度...",
        "生成漏洞报告...",
        "完成分析"
    ];
    
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>正在分析中...';
        
        // 显示进度条
        analysisProgress.classList.remove('d-none');
        
        // 模拟进度更新
        let progress = 0;
        let stageIndex = 0;
        
        function updateProgress() {
            // 根据当前阶段更新进度
            if (progress < 95) {
                // 计算每个阶段的进度增量
                const stageIncrement = Math.random() * 5 + 2; // 2-7之间的随机数
                progress += stageIncrement;
                
                if (progress > (stageIndex + 1) * 20) {
                    stageIndex = Math.min(stageIndex + 1, analysisStages.length - 1);
                    analysisStage.textContent = analysisStages[stageIndex];
                }
                
                // 限制进度最大为95%，剩余5%留给后端返回结果
                progress = Math.min(progress, 95);
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressText.textContent = Math.round(progress) + '%';
                
                // 继续更新进度
                setTimeout(updateProgress, 500 + Math.random() * 1000);
            }
        }
        
        // 开始更新进度
        updateProgress();
    });

    // 漏洞类型分布饼状图
    const vulnTypePieChart = document.getElementById('vulnTypePieChart');
    if (vulnTypePieChart) {
        // 从Django模板中获取漏洞类型数据
        const vulnTypeData = [
            {% for vuln_type, data in vuln_type_percentages.items %}
                {
                    type: "{{ vuln_type }}",
                    count: {{ data.count }},
                    percentage: {{ data.percentage }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        if (vulnTypeData.length > 0) {
            // 准备饼状图数据
            const labels = vulnTypeData.map(item => item.type);
            const counts = vulnTypeData.map(item => item.count);
            const colors = generateColors(vulnTypeData.length);
            
            // 创建饼状图
            new Chart(vulnTypePieChart, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '10%',
                    radius: '90%',
                    layout: {
                        padding: 0
                    },
                    plugins: {
                        legend: {
                            display: false // 隐藏图例，因为表格中已有信息
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.formattedValue || '';
                                    const percentage = vulnTypeData[context.dataIndex].percentage.toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // 如果没有数据，显示提示信息
            vulnTypePieChart.style.display = 'none';
            const noDataMessage = document.createElement('p');
            noDataMessage.textContent = '没有足够的数据生成图表';
            noDataMessage.className = 'text-center text-muted';
            vulnTypePieChart.parentNode.appendChild(noDataMessage);
        }
    }
    
    // 生成随机颜色函数
    function generateColors(count) {
        const baseColors = [
            'rgb(255, 99, 132)',   // 红色
            'rgb(54, 162, 235)',   // 蓝色
            'rgb(255, 206, 86)',   // 黄色
            'rgb(75, 192, 192)',   // 青绿色
            'rgb(153, 102, 255)',  // 紫色
            'rgb(255, 159, 64)',   // 橙色
            'rgb(199, 199, 199)',  // 灰色
            'rgb(83, 102, 255)',   // 靛蓝色
            'rgb(255, 99, 255)',   // 粉色
            'rgb(99, 255, 132)'    // 浅绿色
        ];
        
        // 如果基础颜色不够，随机生成其他颜色
        const colors = [...baseColors];
        while (colors.length < count) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            colors.push(`rgb(${r}, ${g}, ${b})`);
        }
        
        return colors.slice(0, count);
    }

    // CWE查询功能
    const cweSearchForm = document.getElementById('cwe-search-form');
    const cweResult = document.getElementById('cwe-result');
    
    // 查询CWE信息的函数
    function queryCWE(cweNumber) {
        if (!cweNumber) {
            cweResult.innerHTML = '<div class="alert alert-warning">请输入有效的CWE编号</div>';
            return;
        }
        
        // 显示加载状态
        cweResult.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-2">正在查询...</p></div>';
        
        // 使用后端API获取CWE信息
        fetch(`/api/cwe/${cweNumber}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || '获取CWE信息失败');
                }
                
                // 显示结果
                cweResult.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            CWE-${data.cwe_number}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${data.title}</h5>
                            <p class="card-text small">${data.description.substring(0, 300)}${data.description.length > 300 ? '...' : ''}</p>
                            <a href="${data.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                查看完整信息
                            </a>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                cweResult.innerHTML = `<div class="alert alert-danger">错误: ${error.message}</div>`;
            });
    }
    
    // 为搜索表单添加事件监听
    if (cweSearchForm) {
        cweSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const cweNumber = document.getElementById('cwe-number').value.trim();
            queryCWE(cweNumber);
        });
    }
    
    // 为快速查询按钮添加事件监听
    const quickSearchBtn = document.getElementById('quick-search-cwe');
    if (quickSearchBtn) {
        quickSearchBtn.addEventListener('click', function() {
            const cweNumber = this.getAttribute('data-cwe');
            if (cweNumber) {
                // 如果有输入框，填入值
                const cweInput = document.getElementById('cwe-number');
                if (cweInput) {
                    cweInput.value = cweNumber;
                }
                
                // 滚动到查询框
                const cweCard = document.querySelector('.card');
                if (cweCard && cweSearchForm) {
                    const searchCard = cweSearchForm.closest('.card');
                    if (searchCard) {
                        searchCard.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                
                // 执行查询
                queryCWE(cweNumber);
            }
        });
    }
});
</script>
{% endblock %} 