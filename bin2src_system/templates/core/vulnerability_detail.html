{% extends 'core/base.html' %}
{% load core_filters %}

{% block title %}漏洞函数分析详情 - Bin2Vul{% endblock %}

{% block content %}
<div class="vulnerability-theme">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">首页</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'vulnerability_analysis' %}">漏洞函数分析</a></li>
                    <li class="breadcrumb-item active">分析详情</li>
                </ol>
            </nav>
            <h1 class="h3 mb-2">漏洞函数分析详情</h1>
            <p class="text-muted">分析时间: {{ analysis.created_at|date:"Y-m-d H:i" }}</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- 概览信息 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-chart-pie me-2"></i>分析结果概览
                </h5>
                <div class="alert alert-{% if overall_result.similarity_percentage > 70 %}danger{% elif overall_result.similarity_percentage > 50 %}warning{% else %}info{% endif %} mb-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-{% if overall_result.similarity_percentage > 70 %}exclamation-triangle{% elif overall_result.similarity_percentage > 50 %}exclamation-circle{% else %}info-circle{% endif %} fa-2x"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">检测到可能的漏洞</h5>
                            <p class="mb-0">漏洞类型: 
                                {% if 'CWE-' in overall_result.vulnerability_type %}
                                    {% with cwe_id=overall_result.vulnerability_type|cwe_extract %}
                                    {% if cwe_id %}
                                    <span class="badge bg-danger">CWE-{{ cwe_id }}</span>
                                    {% else %}
                                    <strong>{{ overall_result.vulnerability_type }}</strong>
                                    {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <strong>{{ overall_result.vulnerability_type }}</strong>
                                {% endif %}
                                
                                <!-- 使用JavaScript生成不重复的CWE徽章 -->
                                <span id="additional-cwe-badges"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="file-info mb-4">
                    <h6 class="mb-3">文件信息</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th scope="row" style="width: 30%;">文件名</th>
                                    <td>{{ analysis.file1.name }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">分析类型</th>
                                    <td>
                                        <span class="badge bg-danger">漏洞函数分析</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">分析时间</th>
                                    <td>{{ analysis.created_at|date:"Y-m-d H:i:s" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 分析进度条，默认隐藏 -->
                <div id="analysisProgress" class="mt-4 d-none">
                    <p class="text-center mb-2">正在进行漏洞函数分析，请稍候...</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100" 
                             style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    <p class="text-center small text-muted mt-2" id="analysisStage">准备分析二进制文件...</p>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'vulnerability_analysis' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>返回分析页面
                    </a>
                    <a href="{% url 'delete_history' analysis.id %}" 
                       class="btn btn-outline-danger"
                       onclick="return confirm('确定要删除这条历史记录吗？')">
                        <i class="fas fa-trash-alt me-2"></i>删除此记录
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 函数级别漏洞分析结果 -->
        {% if function_results %}
        <div class="card mt-4">
            <div class="card-header bg-danger text-white">
                <i class="fas fa-code me-2"></i>函数级别漏洞分析
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">函数名</th>
                                <th scope="col">漏洞类型</th>
                                <th scope="col">相似度</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in function_results %}
                            <tr class="{% if forloop.first %}table-danger{% endif %}">
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>
                                    {{ result.func_name }}
                                    <div class="small text-muted">偏移量: {{ result.func_offset }}</div>
                                </td>
                                <td>{{ result.vulnerability_type }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-{% if result.similarity_percentage > 70 %}danger{% elif result.similarity_percentage > 50 %}warning{% else %}info{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ result.similarity_percentage }}%"
                                                 aria-valuenow="{{ result.similarity_percentage }}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span class="ms-2">{{ result.similarity_percentage|floatformat:2 }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 相似度结果列表 -->
        {% if similarity_results %}
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-code me-2"></i>漏洞相似度详情
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">漏洞源码</th>
                                <th scope="col">漏洞类型</th>
                                <th scope="col">相似度</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in similarity_results %}
                            <tr class="{% if forloop.first %}table-danger{% endif %}">
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>{{ result.file_name }}</td>
                                <td>{{ result.vulnerability_type }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-{% if result.similarity_percentage > 70 %}danger{% elif result.similarity_percentage > 50 %}warning{% else %}info{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ result.similarity_percentage }}%"
                                                 aria-valuenow="{{ result.similarity_percentage }}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span class="ms-2">{{ result.similarity_percentage|floatformat:2 }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <!-- CWE漏洞查询 -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-search me-2"></i>CWE漏洞查询
            </div>
            <div class="card-body">
                <form id="cwe-search-form">
                    <div class="input-group mb-3">
                        <input type="number" class="form-control" id="cwe-number" placeholder="输入CWE编号" min="1" max="9999">
                        <button class="btn btn-primary" type="submit" id="search-cwe-btn">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </form>
                <div id="cwe-result" class="mt-3">
                    <div class="text-center text-muted small">
                        <p>输入CWE编号查询漏洞详情</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 安全建议 -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-shield-alt me-2"></i>安全建议
            </div>
            <div class="card-body">
                <h6>修复建议:</h6>
                <ul class="mb-0">
                    {% if 'buffer' in overall_result.vulnerability_type|lower or 'overflow' in overall_result.vulnerability_type|lower or 'CWE-119' in overall_result.vulnerability_type or 'CWE-120' in overall_result.vulnerability_type or 'CWE-121' in overall_result.vulnerability_type or 'CWE-122' in overall_result.vulnerability_type %}
                    <li>使用安全的字符串和内存操作函数，如strncpy代替strcpy</li>
                    <li>增加输入验证和边界检查</li>
                    <li>考虑使用更安全的编程语言或启用编译器安全选项</li>
                    {% elif 'use-after-free' in overall_result.vulnerability_type|lower or 'CWE-416' in overall_result.vulnerability_type %}
                    <li>确保在释放内存后将指针设置为NULL</li>
                    <li>实现适当的内存管理策略</li>
                    <li>考虑使用智能指针或自动内存管理</li>
                    {% elif 'format' in overall_result.vulnerability_type|lower or 'CWE-134' in overall_result.vulnerability_type %}
                    <li>使用固定的格式字符串</li>
                    <li>确保用户输入不会直接作为格式字符串参数</li>
                    {% else %}
                    <li>进行全面的代码安全审查</li>
                    <li>遵循安全编码标准和最佳实践</li>
                    <li>实施适当的输入验证和边界检查</li>
                    <li>定期进行漏洞扫描和安全测试</li>
                    {% endif %}
                </ul>
            </div>
        </div>
        
        <!-- 漏洞类型分布饼状图和表格 -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>漏洞类型分布
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <canvas id="vulnTypePieChart" width="100" height="100"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>漏洞类型</th>
                                <th>函数数量</th>
                                <th>比例</th>
                            </tr>
                        </thead>
                        <tbody id="functionTypeTable">
                            <!-- 将通过JavaScript填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- 引入Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 分析进度相关
    const analysisProgress = document.getElementById('analysisProgress');
    const progressBar = analysisProgress ? analysisProgress.querySelector('.progress-bar') : null;
    const progressText = document.getElementById('progressText');
    const analysisStage = document.getElementById('analysisStage');
    
    // 添加不重复CWE徽章的代码
    const functionResults = [
        {% for result in function_results %}
            {
                funcName: "{{ result.func_name|escapejs }}",
                vulnType: "{{ result.vulnerability_type|escapejs }}",
                similarity: {{ result.similarity_percentage|floatformat:1 }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // 提取和显示不重复的CWE编号
    function displayUniqueCWEBadges() {
        const mainCWEElement = document.querySelector('.badge.bg-danger');
        let mainCWE = '';
        
        if (mainCWEElement) {
            mainCWE = mainCWEElement.textContent.trim();
        }
        
        const cweSet = new Set();
        const badgesContainer = document.getElementById('additional-cwe-badges');
        
        if (!badgesContainer) return;
        
        functionResults.forEach(item => {
            const vulnType = item.vulnType;
            const cweMatch = vulnType.match(/CWE-(\d+)/);
            
            if (cweMatch && cweMatch[0]) {
                const cweCode = cweMatch[0];
                if (cweCode !== mainCWE && !cweSet.has(cweCode)) {
                    cweSet.add(cweCode);
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-danger ms-1';
                    badge.textContent = cweCode;
                    badgesContainer.appendChild(badge);
                }
            }
        });
    }
    
    // 调用显示CWE徽章的函数
    displayUniqueCWEBadges();
    
    // 分析阶段描述
    const analysisStages = [
        "准备分析二进制文件...",
        "提取函数特征...",
        "比对已知漏洞库...",
        "分析代码相似度...",
        "生成漏洞报告...",
        "完成分析"
    ];
    
    // 函数级别漏洞分布
    const functionResultsData = functionResults.map(item => ({
        funcName: item.funcName,
        vulnType: item.vulnType,
        similarity: item.similarity
    }));
    
    // 计算漏洞类型分布
    function calculateVulnTypeDistribution(data) {
        if (!data || data.length === 0) {
            return [];
        }
        
        const typeCount = {};
        let totalCount = 0;
        
        // 统计每种漏洞类型的函数数量
        data.forEach(item => {
            const vulnType = item.vulnType || 'Unknown';
            typeCount[vulnType] = (typeCount[vulnType] || 0) + 1;
            totalCount++;
        });
        
        // 转换为期望的数据格式
        return Object.keys(typeCount).map(type => ({
            type: type,
            count: typeCount[type],
            percentage: (typeCount[type] / totalCount) * 100
        }));
    }
    
    // 获取漏洞类型分布数据
    const vulnTypeData = calculateVulnTypeDistribution(functionResultsData);
    
    // 填充表格
    function populateVulnTypeTable(data) {
        const tableBody = document.getElementById('functionTypeTable');
        if (!tableBody) return;
        
        // 清空表格内容
        tableBody.innerHTML = '';
        
        // 按百分比排序
        const sortedData = [...data].sort((a, b) => b.percentage - a.percentage);
        
        if (sortedData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="3" class="text-center">暂无数据</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // 填充表格
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.type}</td>
                <td>${item.count}</td>
                <td>${item.percentage.toFixed(1)}%</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // 漏洞类型分布饼状图
    const vulnTypePieChart = document.getElementById('vulnTypePieChart');
    if (vulnTypePieChart && vulnTypeData.length > 0) {
        // 准备饼状图数据
        const labels = vulnTypeData.map(item => item.type);
        const counts = vulnTypeData.map(item => item.count);
        const colors = generateColors(vulnTypeData);
        
        // 创建饼状图
        new Chart(vulnTypePieChart, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colors,
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '10%',  // 与分析页面保持一致
                radius: '90%',
                layout: {
                    padding: 0
                },
                plugins: {
                    legend: {
                        display: false // 隐藏图例，因为表格中已有信息
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.formattedValue || '';
                                const percentage = vulnTypeData[context.dataIndex].percentage.toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else if (vulnTypePieChart) {
        // 如果没有数据，显示提示信息
        vulnTypePieChart.style.display = 'none';
        const noDataMessage = document.createElement('p');
        noDataMessage.textContent = '没有足够的数据生成图表';
        noDataMessage.className = 'text-center text-muted';
        vulnTypePieChart.parentNode.appendChild(noDataMessage);
    }
    
    // 填充表格
    populateVulnTypeTable(vulnTypeData);
    
    // 生成颜色函数
    function generateColors(data) {
        // 按百分比排序数据
        const sortedData = [...data].sort((a, b) => b.percentage - a.percentage);
        const baseColors = [
            'rgb(255, 99, 132)',   // 红色（最高占比）
            'rgb(54, 162, 235)',   // 蓝色（次高占比）
            'rgb(255, 206, 86)',   // 黄色
            'rgb(75, 192, 192)',   // 青绿色
            'rgb(153, 102, 255)',  // 紫色
            'rgb(255, 159, 64)',   // 橙色
            'rgb(199, 199, 199)',  // 灰色
            'rgb(83, 102, 255)'    // 靛蓝色
        ];
        
        // 创建颜色映射
        const colorMap = new Map();
        sortedData.forEach((item, index) => {
            colorMap.set(item.type, baseColors[index % baseColors.length] || generateRandomColor());
        });
        
        // 返回原始数据顺序的颜色数组
        return data.map(item => colorMap.get(item.type));
    }
    
    // 生成随机颜色
    function generateRandomColor() {
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        return `rgb(${r}, ${g}, ${b})`;
    }
    
    // CWE查询功能
    const cweSearchForm = document.getElementById('cwe-search-form');
    const cweResult = document.getElementById('cwe-result');
    
    // 查询CWE信息的函数
    function queryCWE(cweNumber) {
        if (!cweNumber) {
            cweResult.innerHTML = '<div class="alert alert-warning">请输入有效的CWE编号</div>';
            return;
        }
        
        // 显示加载状态
        cweResult.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-2">正在查询...</p></div>';
        
        // 使用后端API获取CWE信息
        fetch(`/api/cwe/${cweNumber}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || '获取CWE信息失败');
                }
                
                // 显示结果
                cweResult.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            CWE-${data.cwe_number}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${data.title}</h5>
                            <p class="card-text small">${data.description.substring(0, 300)}${data.description.length > 300 ? '...' : ''}</p>
                            <a href="${data.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                查看完整信息
                            </a>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                cweResult.innerHTML = `<div class="alert alert-danger">错误: ${error.message}</div>`;
            });
    }
    
    // 为搜索表单添加事件监听
    if (cweSearchForm) {
        cweSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const cweNumber = document.getElementById('cwe-number').value.trim();
            queryCWE(cweNumber);
        });
    }
    
    // 为快速查询按钮添加事件监听
    const quickSearchBtn = document.getElementById('quick-search-cwe');
    if (quickSearchBtn) {
        quickSearchBtn.addEventListener('click', function() {
            const cweNumber = this.getAttribute('data-cwe');
            if (cweNumber) {
                // 如果有输入框，填入值
                const cweInput = document.getElementById('cwe-number');
                if (cweInput) {
                    cweInput.value = cweNumber;
                }
                
                // 滚动到查询框
                const cweCard = document.querySelector('.card');
                if (cweCard && cweSearchForm) {
                    const searchCard = cweSearchForm.closest('.card');
                    if (searchCard) {
                        searchCard.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                
                // 执行查询
                queryCWE(cweNumber);
            }
        });
    }
});
</script>
{% endblock %} 